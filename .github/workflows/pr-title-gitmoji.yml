name: PR Title Gitmoji Check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    branches:
      - main
      - 'next-*_*_*'
      - 'fix-v*'

permissions:
  contents: read
  pull-requests: read

jobs:
  validate-pr-title:
    name: 'Validate PR title follows gitmoji convention'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate PR title
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const prTitle = context.payload.pull_request.title;

            // Get package names from packages/ directory
            const packagesDir =
              path.join(process.env.GITHUB_WORKSPACE, 'packages');
            const packages =
              fs.readdirSync(packagesDir, { withFileTypes: true })
              .filter(dirent => dirent.isDirectory())
              .map(dirent => dirent.name)
              .filter(name => name !== 'fast-check');

            // Regex: emoji + optional (package) + description
            const match =
              prTitle.match(/^([\p{Emoji}\uFE0F\u200d]+)\s*(?:\(([^)]+)\)\s*)?(.+)$/u);

            if (!match) {
              core.setFailed(
                '❌ Invalid format. Use: emoji Description ' +
                'or emoji(package) Description'
              );
              return;
            }

            const [, emoji, packageName, description] = match;

            if (packageName && !packages.includes(packageName)) {
              core.setFailed(
                `❌ Invalid package "${packageName}". ` +
                `Valid: ${packages.join(', ')}`
              );
              return;
            }

            if (!description.trim()) {
              core.setFailed('❌ Description required');
              return;
            }

            console.log('✅ Valid gitmoji PR title');
