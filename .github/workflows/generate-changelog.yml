name: Generate Changelog

on:
  workflow_dispatch:
    inputs:
      nextVersion:
        description: 'Next version (eg.: 2.20.0)'
        required: true
        type: string

jobs:
  generate_changelog:
    name: "Generate Changelog"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.4.0
        with:
          fetch-depth: 0
      - name: Generate Changelog
        uses: actions/github-script@v5
        with:
          script: |
            const util = require('util');
            const execFile = util.promisify(require('child_process').execFile);
            const nextVersion = process.env.NEXT_VERSION;
            const { stdout: lastTagOutput } = await execFile("git", ["describe", "--tags", "--abbrev=0"]);
            const lastTag = lastTagOutput.trim()
            const { stdout: diffOutput } = await execFile("git", ["--no-pager", "log", `${lastTag}..HEAD`, "--format=%s"]);
            const diffOutputLines = diffOutput.split('\n').map(line => line.trim()).filter(line => line.length !== 0);
            let newFeaturesSection = [];
            let maintenanceSection = [];
            for (const lineDiff of diffOutputLines) {
              const [type, ...titleAndPR] = lineDiff.split(' ');
              const prExtractor =  /^(.*) \(#(\d+)\)$/;
              let title;
              let pr;
              try {
                [,title, pr] = prExtractor.exec(titleAndPR.join(' '));
              } catch (err) {
                console.error(`Failed to extract PR/title from: ${JSON.stringify(lineDiff)}`);
                break;
              }
              switch (type) {
                case "âš¡ï¸":
                case ":zap:":
                case "âœ¨":
                case ":sparkles:":
                  newFeaturesSection.push(`([PR#${pr}](https://github.com/dubzzz/fast-check/pull/${pr})) ${title}`);
                  break;
                case "ðŸ›":
                case ":bug:":
                  maintenanceSection.push({ type: "Bug", pr, title });
                  break;
                case "ðŸ“":
                case ":memo:":
                  maintenanceSection.push({ type: "Doc", pr, title });
                  break;
                case "âœï¸":
                case ":pencil2:":
                  maintenanceSection.push({ type: "Typo", pr, title });
                  break;
                case "âœ…":
                case ":white_check_mark:":
                  maintenanceSection.push({ type: "Test", pr, title });
                  break;
                case "â¬†ï¸":
                case ":arrow_up:":
                  break;
                case "â™»ï¸":
                case ":recycle:":
                  maintenanceSection.push({ type: "Refactor", pr, title });
                  break;
                case "ðŸ’š":
                case ":green_heart:":
                case "ðŸ‘·":
                case ":construction_worker:":
                case "ðŸ”§":
                case ":wrench:":
                  maintenanceSection.push({ type: "CI", pr, title });
                  break;
                case "ðŸ”¨":
                case ":hammer:":
                  maintenanceSection.push({ type: "Script", pr, title });
                  break;
                case "ðŸšš":
                case ":truck:":
                  maintenanceSection.push({ type: "Move", pr, title });
                  break;
                default:
                  console.error(`Unhandled type: ${type}`);
                  break;
              }
            }
            const body = "# " + nextVersion + "\n\n" +
                         "_What happened?_\n" +
                         "[[Code](https://github.com/dubzzz/fast-check/tree/v" + nextVersion +")][[Diff](https://github.com/dubzzz/fast-check/compare/" + lastTag + "...v" + nextVersion + ")]\n\n" +
                         "## Features\n\n" +
                         newFeaturesSection.map(line => `- ${line}`).join('\n') + "\n\n" +
                         "## Fixes\n\n" +
                         maintenanceSection
                           .sort((a, b) => a.type.localeCompare(b.type))
                           .map(({type, title, pr}) => `- ([PR#${pr}](https://github.com/dubzzz/fast-check/pull/${pr})) ${type}: ${title}`)
                           .join('\n') + "\n\n";
            console.log(body);
        env:
          NEXT_VERSION: ${{github.event.inputs.nextVersion}}
