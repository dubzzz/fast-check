name: Build Status

on:
  push:
    branches:
      - main
      - 'next-*_*_*'
      - 'fix-v*'
  pull_request:
    branches:
      - main
      - 'next-*_*_*'
      - 'fix-v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test_bundle:
    name: 'Test bundle'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4.1.0
      - name: Using Node v18.x
        uses: actions/setup-node@5e21ff4d9bc1a8cf6de233a3057d20ec6b3fb69d # v3.8.1
        with:
          node-version: '18.x'
          cache: 'yarn'
          check-latest: true
      - name: Launch install
        run: |
          export NVS_HOME="$HOME/.nvs"
          git clone --branch v1.7.1 --depth 1 https://github.com/jasongin/nvs "$NVS_HOME"
          if [ "$(git -C "$NVS_HOME" rev-parse HEAD)" != "b87ae9593cd20e7b667e9099240c9befeb50659f" ]; then
              echo "ERROR: HEAD is not the expected commit hash"
              exit 1
          fi
          . "$NVS_HOME/nvs.sh" install
          echo "0!!!" && nvs add 8
          echo "1!!!" && cd packages/fast-check
          echo "2!!!" && cat package.json | grep test-legacy-bundle | sed -E 's/\s*"test-legacy-bundle": "(.*)",/\1/g' | bash
          echo "3!!!" && cd ../..
          echo "4!!!" yarn workspaces foreach -pvi --no-private run test-legacy-bundle
          echo "5!!!" yarn workspaces foreach -pvi --no-private exec "cat package.json | grep test-legacy-bundle | sed -E 's/\s*"test-legacy-bundle": "(.*)",/\1/g' | bash"
