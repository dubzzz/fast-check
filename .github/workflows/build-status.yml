name: Build Status

on:
  push:
    branches:
      - main
      - 'next-*_*_*'
      - 'fix-v*'
  pull_request:
    branches:
      - main
      - 'next-*_*_*'
      - 'fix-v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # Root jobs
  warmup_pnpm_cache:
    name: 'Warm up pnpm cache'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        id: pnpm-cache
        with:
          node-version: '24.x'
          cache: 'pnpm'
      - name: Update pnpm cache
        if: steps.pnpm-cache.outputs.cache-hit != 'true'
        run: pnpm install --frozen-lockfile
  warmup_pnpm_cache_others:
    name: 'Warm up pnpm cache (others)'
    runs-on: ${{matrix.os}}
    strategy:
      matrix:
        os: ['macos-latest', 'windows-latest']
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        id: pnpm-cache
        with:
          node-version: '24.x'
          cache: 'pnpm'
      - name: Update pnpm cache
        if: steps.pnpm-cache.outputs.cache-hit != 'true'
        run: pnpm install --frozen-lockfile

  # Jobs without any strong requirement on warmup_pnpm_cache
  # except that they have to wait for it to avoid setting an empty cache that would replace the one pushed by warmup_pnpm_cache
  no_dedupe_required:
    name: 'No dedupe required'
    needs: warmup_pnpm_cache
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          cache: 'pnpm'
      - name: Ensure no dedupe required
        run: pnpm dedupe --check
  package_quality:
    name: 'Package quality'
    needs: warmup_pnpm_cache
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          cache: 'pnpm'
      - name: Check package score using skypack
        run: cd packages/fast-check && pnpm dlx @skypack/package-check

  # Jobs requesting warmup_pnpm_cache
  format_lint:
    name: 'Format & Lint'
    needs: warmup_pnpm_cache
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm --filter @fast-check/monorepo install --frozen-lockfile
      - name: Check format
        run: node --run format:check
      - name: Check lint
        run: node --run lint:check
  production_packages:
    name: 'Build production packages'
    needs: warmup_pnpm_cache
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build production packages
        run: node --run build-ci:all
      - name: Create bundles
        run: node --run pack:all
      - name: Upload production packages
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: bundles
          path: packages/**/package.tgz
          if-no-files-found: error
          retention-days: 1

  # Jobs requesting warmup_pnpm_cache AND production_packages
  typecheck:
    name: 'Typecheck'
    needs:
      - warmup_pnpm_cache
      - production_packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Download production packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: bundles
          path: packages/
      - name: Unpack production packages
        run: node --run unpack:all
      - name: Typecheck
        run: node --run typecheck:all
  preview:
    name: 'Preview'
    needs:
      - warmup_pnpm_cache
      - production_packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Download production packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: bundles
          path: packages/
      - name: Unpack production packages
        run: node --run unpack:all
      - name: Preview (no comment)
        if: github.event_name != 'pull_request'
        run: pnpm dlx pkg-pr-new publish --compact './packages/*' --template './examples' --comment=off
      - name: Preview
        if: github.event_name == 'pull_request'
        run: pnpm dlx pkg-pr-new publish --compact './packages/*' --template './examples'
  test:
    name: 'Test'
    needs:
      - warmup_pnpm_cache
      - warmup_pnpm_cache_others
      - production_packages
    runs-on: ${{matrix.os}}
    strategy:
      matrix:
        node-version: [22.x, 24.x, latest]
        os: ['ubuntu-latest']
        shard-id: ['1']
        shard-count: ['1']
        include:
          - node-version: 24.x
            os: 'macos-latest'
            shard-id: 1
            shard-count: 3
          - node-version: 24.x
            os: 'macos-latest'
            shard-id: 2
            shard-count: 3
          - node-version: 24.x
          - node-version: 24.x
            os: 'macos-latest'
            shard-id: 3
            shard-count: 3
          - node-version: 24.x
            os: 'windows-latest'
            shard-id: 1
            shard-count: 3
          - node-version: 24.x
            os: 'windows-latest'
            shard-id: 2
            shard-count: 3
          - node-version: 24.x
            os: 'windows-latest'
            shard-id: 3
            shard-count: 3
    env:
      ENABLE_COVERAGE: ${{ matrix.os == 'macos-latest' }}
      SKIP_EXPENSIVE: ${{ matrix.os == 'windows-latest' }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - name: Using Node v${{matrix.node-version}}
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{matrix.node-version}}
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Download production packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: bundles
          path: packages/
      - name: Unpack production packages
        if: matrix.os != 'windows-latest'
        run: pnpm run unpack:all
      - name: Unpack production packages (Windows only)
        if: matrix.os == 'windows-latest'
        # untar seems to fail on Windows when untaring already existing files
        run: pnpm run unpack:all || true
      - name: Unit tests
        shell: bash -l {0}
        # The DEFAULT_SEED might be used by some of the packages and might be ignored by others
        # It's aim is to help to diagnose infinite loop that may occur during tests and cannot be stopped by fast-check itself
        run: |
          export EXPECT_DEFAULT_SEED="true"
          export DEFAULT_SEED=$(node -p "Date.now() ^ (Math.random() * 0x100000000)")
          export FAST_CI_RUN=$("${ENABLE_COVERAGE}" = "true")
          echo "DEFAULT_SEED is: ${DEFAULT_SEED}"
          if [ "${ENABLE_COVERAGE}" = "true" ]; then
            pnpm run test:coverage --shard=${{matrix.shard-id}}/${{matrix.shard-count}}
          else
            pnpm run test --shard=${{matrix.shard-id}}/${{matrix.shard-count}}
          fi
      - name: Upload coverage
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: env.ENABLE_COVERAGE == 'true'
        with:
          name: 'coverage-${{matrix.shard-id}}'
          path: coverage/
          if-no-files-found: error
          retention-days: 1
  publish_test_coverage:
    name: 'Publish test coverage'
    needs:
      - test
    runs-on: 'ubuntu-latest'
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Download coverage
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: coverage-*
          path: coverage-reports/
      - name: Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          name: tests
          flags: tests
          token: ${{secrets.CODECOV_TOKEN}}
          fail_ci_if_error: true # default: false
          verbose: false # default: false
  documentation:
    name: 'Build documentation'
    needs:
      - warmup_pnpm_cache
      - production_packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0 # all history in order to be able to show last-edited-at dates
      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm --filter website install --frozen-lockfile
      - name: Download production packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: bundles
          path: packages/
      - name: Unpack production packages
        run: node --run unpack:all
      - name: Get date cache buster
        id: get-date
        shell: bash
        run: echo "date=$(/bin/date -u "+%Y%m")" >> $GITHUB_OUTPUT
      - name: Cache for assets
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
        with:
          path: |
            website/static/img/sponsors.svg
            website/static/img/_
            website/static/img/**/*.gif
            website/static/img/**/*.png
          key: assets-${{steps.get-date.outputs.date}}-${{hashFiles('.all-contributorsrc', 'website/prebuild/optimize-images.mjs')}}
      - name: Generate documentation
        run: pnpm --filter website run build
      - name: Generate API reference
        run: |
          pnpm --filter fast-check install --frozen-lockfile
          pnpm --filter fast-check run docs-ci
      - name: Copy API reference within documentation
        run: mv packages/fast-check/docs website/build/api-reference
      - name: Copy raw logo within documentation
        run: cp website/static/img/logo.png website/build/assets/images/logo.png
      - name: Upload documentation artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: website
          path: website/build/
          if-no-files-found: error
          retention-days: 1
  test_bundle:
    name: 'Test bundle'
    needs:
      - warmup_pnpm_cache
      - production_packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Download production packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: bundles
          path: packages/
      - name: Unpack production packages
        run: node --run unpack:all
      - name: Alter internals to behave as if published
        run: pnpm --filter {./packages/**} --parallel exec $(pnpm bin)/packaged --keep-node-modules
      - name: Retrieve potentially dropped test-bundle
        run: pnpm --filter {./packages/**} --parallel -c --workspace-concurrency=1 exec "git restore -s@ -SW -- test-bundle || true"
      - name: Check publication lint
        run: node --run publint:all
      - name: Check bundles
        run: pnpm --filter {./packages/**} --parallel run test-bundle
      - name: Check legacy bundles
        run: |
          export NODE_VERSION="$(node --version)"
          export NVS_HOME="$HOME/.nvs"
          git clone --branch v1.7.1 --depth 1 https://github.com/jasongin/nvs "$NVS_HOME"
          if [ "$(git -C "$NVS_HOME" rev-parse HEAD)" != "b87ae9593cd20e7b667e9099240c9befeb50659f" ]; then
              echo "ERROR: HEAD is not the expected commit hash"
              exit 1
          fi
          chmod +x "$NVS_HOME/nvs"
          export PATH="$PATH:$NVS_HOME"
          if [ "$(node --version)" != "$NODE_VERSION" ]; then
              echo "ERROR: Node version got updated from $NODE_VERSION to $(node --version)"
              exit 2
          fi
          pnpm --filter {./packages/**} --parallel run test-legacy-bundle
          if [ "$(node --version)" != "$NODE_VERSION" ]; then
              echo "ERROR: Node version got updated from $NODE_VERSION to $(node --version)"
              exit 3
          fi
  test_types:
    name: 'Test types'
    needs:
      - warmup_pnpm_cache
      - production_packages
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ts-version:
          # Latest version of TypeScript
          - 'latest'
          # Various intermediate versions of Typescript (if any required)
          - '5.8' # First version supporting require(esm)
          - '5.7' # First version adding generics on Uint8Array
          # Minimal requirement for TypeScript
          - '5.0'
          # Other release channels for TypeScript
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Download production packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: bundles
          path: packages/
      - name: Unpack production packages
        run: node --run unpack:all
      - name: Alter internals to behave as if published
        run: pnpm --filter {./packages/**} --parallel exec $(pnpm bin)/packaged --keep-node-modules
      - name: Retrieve dropped test-types
        run: pnpm --filter {./packages/**} --parallel -c --workspace-concurrency=1 exec "git restore -s@ -SW -- test-types"
      - name: Switch folder to CommonJS
        run: pnpm --filter {./packages/**} --parallel -c exec "cd test-types && ../../../.github/scripts/rename.sh ts cts"
      - name: Check in CommonJS mode
        run: pnpm --filter {./packages/**} --filter '!@fast-check/ava' --filter '!@fast-check/packaged' --filter '!@fast-check/poisoning' --filter '!@fast-check/vitest' --parallel -c exec "cd test-types && pnpm --package typescript@${{ matrix.ts-version }} dlx tsc --noEmit --skipLibCheck --strict *.cts"
      - name: Check in CommonJS mode with NodeNext
        run: pnpm --filter {./packages/**} --filter '!@fast-check/ava' --filter '!@fast-check/packaged' --filter '!@fast-check/poisoning' --filter '!@fast-check/vitest' --parallel -c exec "cd test-types && pnpm --package typescript@${{ matrix.ts-version }} dlx tsc --noEmit --skipLibCheck --strict --module NodeNext --moduleResolution NodeNext *.cts"
      - name: Switch folder to ES Modules
        run: pnpm --filter {./packages/**} --parallel -c exec "cd test-types && ../../../.github/scripts/rename.sh cts mts"
      - name: Check in ES Modules mode
        run: |
          if [ "${{ matrix.ts-version }}" = "5.0" ] || [ "${{ matrix.ts-version }}" = "5.7" ]; then
            pnpm --filter {./packages/**} --filter '!@fast-check/ava' --filter '!@fast-check/packaged' --filter '!@fast-check/poisoning' --filter '!@fast-check/vitest' --parallel -c exec "cd test-types && pnpm --package typescript@${{ matrix.ts-version }} dlx tsc --noEmit --skipLibCheck --strict *.mts"
          else
            pnpm --filter {./packages/**} --filter '!@fast-check/ava' --filter '!@fast-check/packaged' --filter '!@fast-check/poisoning' --filter '!@fast-check/vitest' --parallel -c exec "cd test-types && pnpm --package typescript@${{ matrix.ts-version }} dlx tsc --noEmit --skipLibCheck --strict *.mts"
          fi
      - name: Check in ES Modules mode with NodeNext
        run: |
          if [ "${{ matrix.ts-version }}" = "5.0" ] || [ "${{ matrix.ts-version }}" = "5.7" ]; then
            pnpm --filter {./packages/**} --filter '!@fast-check/ava' --filter '!@fast-check/packaged' --filter '!@fast-check/poisoning' --filter '!@fast-check/vitest' --parallel -c exec "cd test-types && pnpm --package typescript@${{ matrix.ts-version }} dlx tsc --noEmit --skipLibCheck --strict --module NodeNext --moduleResolution NodeNext *.mts"
          else
            pnpm --filter {./packages/**} --parallel -c exec "cd test-types && pnpm --package typescript@${{ matrix.ts-version }} dlx tsc --noEmit --skipLibCheck --strict --module NodeNext --moduleResolution NodeNext *.mts"
          fi

  # Job to confirm every required job passed
  pre_all_checks_passed:
    name: 'Pre All checks passed'
    needs:
      - production_packages
      - documentation
      - format_lint
      - no_dedupe_required
      - package_quality
      - typecheck
      - test
      - test_bundle
      - test_types
    runs-on: ubuntu-latest
    steps:
      - name: Success
        run: echo "Success"
  all_checks_passed:
    name: 'All checks passed'
    needs: pre_all_checks_passed
    if: always()
    runs-on: ubuntu-latest
    steps:
      - if: needs.pre_all_checks_passed.result == 'success'
        name: Success
        run: echo "Success"
      - if: needs.pre_all_checks_passed.result != 'success'
        name: Failure
        run: exit 1

  # Publication jobs
  publish_documentation_netlify:
    name: 'Publish documentation on Netlify'
    needs: documentation
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    env:
      DRAFT_BUILD: ${{github.event_name == 'push' && github.ref == 'refs/heads/main' && 'false' || 'true'}}
    steps:
      - name: Download documentation artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: website
          path: artifacts/
      - name: Alter robots.txt for draft build
        if: env.DRAFT_BUILD == 'true'
        run: |
          echo "User-agent: *" > artifacts/robots.txt
          echo "Disallow: /" >> artifacts/robots.txt
      - name: Configure custom headers
        run: |
          echo "/*" > artifacts/_headers
          echo "  Content-Security-Policy: default-src 'self'; img-src 'self' data: badge.fury.io *.cloudfront.net img.shields.io raw.githubusercontent.com www.netlify.com api.securityscorecards.dev bestpractices.coreinfrastructure.org www.bestpractices.dev cdn.bsky.app;connect-src *.algolia.net askai.algolia.com *.algolianet.com public.api.bsky.app api.counterapi.dev;script-src 'self' 'unsafe-inline' 'unsafe-eval';frame-src 'self' *.codesandbox.io www.youtube-nocookie.com; style-src 'self' 'unsafe-inline'; manifest-src 'self'; base-uri fast-check.dev;" >> artifacts/_headers
          echo "/api-reference/*" >> artifacts/_headers
          echo "  Content-Security-Policy: default-src 'none'; img-src 'self' data:; connect-src data:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" >> artifacts/_headers
      - name: Compress documentation artifacts as zip
        run: zip -r artifacts.zip artifacts
      - name: Deploy to Netlify
        id: deployment_to_netlify
        env:
          DRAFT_BUILD_VALUE: ${{env.DRAFT_BUILD}}
        run: |
          curl -H "Content-Type: application/zip" -H "Authorization: Bearer ${{secrets.NETLIFY_AUTH_TOKEN}}" --data-binary "@artifacts.zip" https://api.netlify.com/api/v1/sites/${{secrets.NETLIFY_SITE_ID}}/deploys?draft=$DRAFT_BUILD_VALUE > deploy.json
          cat deploy.json
          deploy_url=$(jq -r '.deploy_url' --exit-status deploy.json)
          echo "deploy_url=$deploy_url" >> $GITHUB_OUTPUT
      - uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        name: Notify the user of the preview
        if: env.DRAFT_BUILD == 'true'
        env:
          DEPLOY_URL: ${{steps.deployment_to_netlify.outputs.deploy_url}}
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ‘‹ A preview of the new documentation is available at: ${process.env.DEPLOY_URL}`
            })
  check_any_package:
    name: 'Check publish any package'
    needs: all_checks_passed
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    outputs:
      tag_count: ${{steps.tag_count.outputs.count}}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0
      - id: tag_count
        name: Check if one tag matches the package
        run: |
          echo -n "count=" >> "$GITHUB_OUTPUT"
          git tag --points-at HEAD | wc -l >> "$GITHUB_OUTPUT"
  check_publish_fc:
    name: Check publish fast-check
    needs: check_any_package
    if: needs.check_any_package.outputs.tag_count != '0'
    runs-on: ubuntu-latest
    outputs:
      status: ${{steps.check_has_tag.outcome}}
      tag: ${{steps.check_has_tag.outputs.tag}}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0
      - id: check_has_tag
        name: Check if one tag matches the package
        run: echo "tag=$(git tag --points-at HEAD | grep '^v[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*' || true)" >> "$GITHUB_OUTPUT"
  publish_package_fc:
    name: Publish fast-check
    needs: check_publish_fc
    if: needs.check_publish_fc.outputs.tag != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'
          check-latest: true
      - name: Download production packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: bundles
          path: packages/
      - uses: step-security/wait-for-secrets@084b3ae774c0e0003a9307ae4f487c10f1f998fe # v1.2.1
        id: wait-for-secrets
        with:
          secrets: |
            OTP: 
              name: 'OTP to publish package'
              description: 'OTP from authenticator app'
      - name: Set package filename
        run: echo "TGZ_NAME=fast-check-$(tar -xzOf packages/fast-check/package.tgz package/package.json | jq -r '.version').tgz" >> $GITHUB_ENV
      - name: Rename package for publication
        run: mv packages/fast-check/package.tgz "packages/fast-check/$TGZ_NAME"
      - name: Publish fast-check
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
          PUBLISH_TAG: ${{github.ref == 'refs/heads/main' && 'latest' || startsWith(github.ref, 'refs/heads/next-') && 'next' || 'legacy'}}
          OTP_VALUE: ${{steps.wait-for-secrets.outputs.OTP}}
        run: npm publish --access public --otp "$OTP_VALUE" --tag "$PUBLISH_TAG" "packages/fast-check/$TGZ_NAME"
      - uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        id: attest
        with:
          subject-path: packages/fast-check/${{env.TGZ_NAME}}
      - name: Rename attestation bundle
        run: mv "$BUNDLE_PATH" "packages/fast-check/$TGZ_NAME.sigstore.json"
        env:
          BUNDLE_PATH: ${{steps.attest.outputs.bundle-path}}
      - name: Update GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{needs.check_publish_fc.outputs.tag}}
          append_body: true
          fail_on_unmatched_files: true
          overwrite_files: false
          files: |
            packages/fast-check/${{env.TGZ_NAME}}
            packages/fast-check/${{env.TGZ_NAME}}.sigstore.json
          body: |

            [View attestation](${{steps.attest.outputs.attestation-url}}) â€¢ [Documentation](https://docs.github.com/en/actions/security-for-github-actions/using-artifact-attestations)
  check_publish_ava:
    name: Check publish @fast-check/ava
    needs: check_any_package
    if: needs.check_any_package.outputs.tag_count != '0'
    runs-on: ubuntu-latest
    outputs:
      status: ${{steps.check_has_tag.outcome}}
      tag: ${{steps.check_has_tag.outputs.tag}}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0
      - id: check_has_tag
        name: Check if one tag matches the package
        run: echo "tag=$(git tag --points-at HEAD | grep '^ava/v[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*' || true)" >> "$GITHUB_OUTPUT"
  publish_package_ava:
    name: Publish @fast-check/ava
    needs: check_publish_ava
    if: needs.check_publish_ava.outputs.tag != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'
          check-latest: true
      - name: Download production packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: bundles
          path: packages/
      - uses: step-security/wait-for-secrets@084b3ae774c0e0003a9307ae4f487c10f1f998fe # v1.2.1
        id: wait-for-secrets
        with:
          secrets: |
            OTP: 
              name: 'OTP to publish package'
              description: 'OTP from authenticator app'
      - name: Set package filename
        run: echo "TGZ_NAME=ava-$(tar -xzOf packages/ava/package.tgz package/package.json | jq -r '.version').tgz" >> $GITHUB_ENV
      - name: Rename package for publication
        run: mv packages/ava/package.tgz "packages/ava/$TGZ_NAME"
      - name: Publish @fast-check/ava
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
          PUBLISH_TAG: ${{github.ref == 'refs/heads/main' && 'latest' || startsWith(github.ref, 'refs/heads/next-') && 'next' || 'legacy'}}
          OTP_VALUE: ${{steps.wait-for-secrets.outputs.OTP}}
        run: npm publish --access public --otp "$OTP_VALUE" --tag "$PUBLISH_TAG" "packages/ava/$TGZ_NAME"
      - uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        id: attest
        with:
          subject-path: packages/ava/${{env.TGZ_NAME}}
      - name: Rename attestation bundle
        run: mv "$BUNDLE_PATH" "packages/ava/$TGZ_NAME.sigstore.json"
        env:
          BUNDLE_PATH: ${{steps.attest.outputs.bundle-path}}
      - name: Update GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{needs.check_publish_ava.outputs.tag}}
          append_body: true
          fail_on_unmatched_files: true
          overwrite_files: false
          files: |
            packages/ava/${{env.TGZ_NAME}}
            packages/ava/${{env.TGZ_NAME}}.sigstore.json
          body: |

            [View attestation](${{steps.attest.outputs.attestation-url}}) â€¢ [Documentation](https://docs.github.com/en/actions/security-for-github-actions/using-artifact-attestations)
  check_publish_jest:
    name: Check publish @fast-check/jest
    needs: check_any_package
    if: needs.check_any_package.outputs.tag_count != '0'
    runs-on: ubuntu-latest
    outputs:
      status: ${{steps.check_has_tag.outcome}}
      tag: ${{steps.check_has_tag.outputs.tag}}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0
      - id: check_has_tag
        name: Check if one tag matches the package
        run: echo "tag=$(git tag --points-at HEAD | grep '^jest/v[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*' || true)" >> "$GITHUB_OUTPUT"
  publish_package_jest:
    name: Publish @fast-check/jest
    needs: check_publish_jest
    if: needs.check_publish_jest.outputs.tag != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'
          check-latest: true
      - name: Download production packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: bundles
          path: packages/
      - uses: step-security/wait-for-secrets@084b3ae774c0e0003a9307ae4f487c10f1f998fe # v1.2.1
        id: wait-for-secrets
        with:
          secrets: |
            OTP: 
              name: 'OTP to publish package'
              description: 'OTP from authenticator app'
      - name: Set package filename
        run: echo "TGZ_NAME=jest-$(tar -xzOf packages/jest/package.tgz package/package.json | jq -r '.version').tgz" >> $GITHUB_ENV
      - name: Rename package for publication
        run: mv packages/jest/package.tgz "packages/jest/$TGZ_NAME"
      - name: Publish @fast-check/jest
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
          PUBLISH_TAG: ${{github.ref == 'refs/heads/main' && 'latest' || startsWith(github.ref, 'refs/heads/next-') && 'next' || 'legacy'}}
          OTP_VALUE: ${{steps.wait-for-secrets.outputs.OTP}}
        run: npm publish --access public --otp "$OTP_VALUE" --tag "$PUBLISH_TAG" "packages/jest/$TGZ_NAME"
      - uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        id: attest
        with:
          subject-path: packages/jest/${{env.TGZ_NAME}}
      - name: Rename attestation bundle
        run: mv "$BUNDLE_PATH" "packages/jest/$TGZ_NAME.sigstore.json"
        env:
          BUNDLE_PATH: ${{steps.attest.outputs.bundle-path}}
      - name: Update GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{needs.check_publish_jest.outputs.tag}}
          append_body: true
          fail_on_unmatched_files: true
          overwrite_files: false
          files: |
            packages/jest/${{env.TGZ_NAME}}
            packages/jest/${{env.TGZ_NAME}}.sigstore.json
          body: |

            [View attestation](${{steps.attest.outputs.attestation-url}}) â€¢ [Documentation](https://docs.github.com/en/actions/security-for-github-actions/using-artifact-attestations)
  check_publish_packaged:
    name: Check publish @fast-check/packaged
    needs: check_any_package
    if: needs.check_any_package.outputs.tag_count != '0'
    runs-on: ubuntu-latest
    outputs:
      status: ${{steps.check_has_tag.outcome}}
      tag: ${{steps.check_has_tag.outputs.tag}}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0
      - id: check_has_tag
        name: Check if one tag matches the package
        run: echo "tag=$(git tag --points-at HEAD | grep '^packaged/v[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*' || true)" >> "$GITHUB_OUTPUT"
  publish_package_packaged:
    name: Publish @fast-check/packaged
    needs: check_publish_packaged
    if: needs.check_publish_packaged.outputs.tag != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'
          check-latest: true
      - name: Download production packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: bundles
          path: packages/
      - uses: step-security/wait-for-secrets@084b3ae774c0e0003a9307ae4f487c10f1f998fe # v1.2.1
        id: wait-for-secrets
        with:
          secrets: |
            OTP: 
              name: 'OTP to publish package'
              description: 'OTP from authenticator app'
      - name: Set package filename
        run: echo "TGZ_NAME=packaged-$(tar -xzOf packages/packaged/package.tgz package/package.json | jq -r '.version').tgz" >> $GITHUB_ENV
      - name: Rename package for publication
        run: mv packages/packaged/package.tgz "packages/packaged/$TGZ_NAME"
      - name: Publish @fast-check/packaged
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
          PUBLISH_TAG: ${{github.ref == 'refs/heads/main' && 'latest' || startsWith(github.ref, 'refs/heads/next-') && 'next' || 'legacy'}}
          OTP_VALUE: ${{steps.wait-for-secrets.outputs.OTP}}
        run: npm publish --access public --otp "$OTP_VALUE" --tag "$PUBLISH_TAG" "packages/packaged/$TGZ_NAME"
      - uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        id: attest
        with:
          subject-path: packages/packaged/${{env.TGZ_NAME}}
      - name: Rename attestation bundle
        run: mv "$BUNDLE_PATH" "packages/packaged/$TGZ_NAME.sigstore.json"
        env:
          BUNDLE_PATH: ${{steps.attest.outputs.bundle-path}}
      - name: Update GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{needs.check_publish_packaged.outputs.tag}}
          append_body: true
          fail_on_unmatched_files: true
          overwrite_files: false
          files: |
            packages/packaged/${{env.TGZ_NAME}}
            packages/packaged/${{env.TGZ_NAME}}.sigstore.json
          body: |

            [View attestation](${{steps.attest.outputs.attestation-url}}) â€¢ [Documentation](https://docs.github.com/en/actions/security-for-github-actions/using-artifact-attestations)
  check_publish_poisoning:
    name: Check publish @fast-check/poisoning
    needs: check_any_package
    if: needs.check_any_package.outputs.tag_count != '0'
    runs-on: ubuntu-latest
    outputs:
      status: ${{steps.check_has_tag.outcome}}
      tag: ${{steps.check_has_tag.outputs.tag}}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0
      - id: check_has_tag
        name: Check if one tag matches the package
        run: echo "tag=$(git tag --points-at HEAD | grep '^poisoning/v[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*' || true)" >> "$GITHUB_OUTPUT"
  publish_package_poisoning:
    name: Publish @fast-check/poisoning
    needs: check_publish_poisoning
    if: needs.check_publish_poisoning.outputs.tag != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'
          check-latest: true
      - name: Download production packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: bundles
          path: packages/
      - uses: step-security/wait-for-secrets@084b3ae774c0e0003a9307ae4f487c10f1f998fe # v1.2.1
        id: wait-for-secrets
        with:
          secrets: |
            OTP: 
              name: 'OTP to publish package'
              description: 'OTP from authenticator app'
      - name: Set package filename
        run: echo "TGZ_NAME=poisoning-$(tar -xzOf packages/poisoning/package.tgz package/package.json | jq -r '.version').tgz" >> $GITHUB_ENV
      - name: Rename package for publication
        run: mv packages/poisoning/package.tgz "packages/poisoning/$TGZ_NAME"
      - name: Publish @fast-check/poisoning
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
          PUBLISH_TAG: ${{github.ref == 'refs/heads/main' && 'latest' || startsWith(github.ref, 'refs/heads/next-') && 'next' || 'legacy'}}
          OTP_VALUE: ${{steps.wait-for-secrets.outputs.OTP}}
        run: npm publish --access public --otp "$OTP_VALUE" --tag "$PUBLISH_TAG" "packages/poisoning/$TGZ_NAME"
      - uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        id: attest
        with:
          subject-path: packages/poisoning/${{env.TGZ_NAME}}
      - name: Rename attestation bundle
        run: mv "$BUNDLE_PATH" "packages/poisoning/$TGZ_NAME.sigstore.json"
        env:
          BUNDLE_PATH: ${{steps.attest.outputs.bundle-path}}
      - name: Update GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{needs.check_publish_poisoning.outputs.tag}}
          append_body: true
          fail_on_unmatched_files: true
          overwrite_files: false
          files: |
            packages/poisoning/${{env.TGZ_NAME}}
            packages/poisoning/${{env.TGZ_NAME}}.sigstore.json
          body: |

            [View attestation](${{steps.attest.outputs.attestation-url}}) â€¢ [Documentation](https://docs.github.com/en/actions/security-for-github-actions/using-artifact-attestations)
  check_publish_vitest:
    name: Check publish @fast-check/vitest
    needs: check_any_package
    if: needs.check_any_package.outputs.tag_count != '0'
    runs-on: ubuntu-latest
    outputs:
      status: ${{steps.check_has_tag.outcome}}
      tag: ${{steps.check_has_tag.outputs.tag}}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0
      - id: check_has_tag
        name: Check if one tag matches the package
        run: echo "tag=$(git tag --points-at HEAD | grep '^vitest/v[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*' || true)" >> "$GITHUB_OUTPUT"
  publish_package_vitest:
    name: Publish @fast-check/vitest
    needs: check_publish_vitest
    if: needs.check_publish_vitest.outputs.tag != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'
          check-latest: true
      - name: Download production packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: bundles
          path: packages/
      - uses: step-security/wait-for-secrets@084b3ae774c0e0003a9307ae4f487c10f1f998fe # v1.2.1
        id: wait-for-secrets
        with:
          secrets: |
            OTP: 
              name: 'OTP to publish package'
              description: 'OTP from authenticator app'
      - name: Set package filename
        run: echo "TGZ_NAME=vitest-$(tar -xzOf packages/vitest/package.tgz package/package.json | jq -r '.version').tgz" >> $GITHUB_ENV
      - name: Rename package for publication
        run: mv packages/vitest/package.tgz "packages/vitest/$TGZ_NAME"
      - name: Publish @fast-check/vitest
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
          PUBLISH_TAG: ${{github.ref == 'refs/heads/main' && 'latest' || startsWith(github.ref, 'refs/heads/next-') && 'next' || 'legacy'}}
          OTP_VALUE: ${{steps.wait-for-secrets.outputs.OTP}}
        run: npm publish --access public --otp "$OTP_VALUE" --tag "$PUBLISH_TAG" "packages/vitest/$TGZ_NAME"
      - uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        id: attest
        with:
          subject-path: packages/vitest/${{env.TGZ_NAME}}
      - name: Rename attestation bundle
        run: mv "$BUNDLE_PATH" "packages/vitest/$TGZ_NAME.sigstore.json"
        env:
          BUNDLE_PATH: ${{steps.attest.outputs.bundle-path}}
      - name: Update GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{needs.check_publish_vitest.outputs.tag}}
          append_body: true
          fail_on_unmatched_files: true
          overwrite_files: false
          files: |
            packages/vitest/${{env.TGZ_NAME}}
            packages/vitest/${{env.TGZ_NAME}}.sigstore.json
          body: |

            [View attestation](${{steps.attest.outputs.attestation-url}}) â€¢ [Documentation](https://docs.github.com/en/actions/security-for-github-actions/using-artifact-attestations)
  check_publish_worker:
    name: Check publish @fast-check/worker
    needs: check_any_package
    if: needs.check_any_package.outputs.tag_count != '0'
    runs-on: ubuntu-latest
    outputs:
      status: ${{steps.check_has_tag.outcome}}
      tag: ${{steps.check_has_tag.outputs.tag}}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0
      - id: check_has_tag
        name: Check if one tag matches the package
        run: echo "tag=$(git tag --points-at HEAD | grep '^worker/v[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*' || true)" >> "$GITHUB_OUTPUT"
  publish_package_worker:
    name: Publish @fast-check/worker
    needs: check_publish_worker
    if: needs.check_publish_worker.outputs.tag != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
      - name: Using Node v24.x
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'
          check-latest: true
      - name: Download production packages
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: bundles
          path: packages/
      - uses: step-security/wait-for-secrets@084b3ae774c0e0003a9307ae4f487c10f1f998fe # v1.2.1
        id: wait-for-secrets
        with:
          secrets: |
            OTP: 
              name: 'OTP to publish package'
              description: 'OTP from authenticator app'
      - name: Set package filename
        run: echo "TGZ_NAME=worker-$(tar -xzOf packages/worker/package.tgz package/package.json | jq -r '.version').tgz" >> $GITHUB_ENV
      - name: Rename package for publication
        run: mv packages/worker/package.tgz "packages/worker/$TGZ_NAME"
      - name: Publish @fast-check/worker
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
          PUBLISH_TAG: ${{github.ref == 'refs/heads/main' && 'latest' || startsWith(github.ref, 'refs/heads/next-') && 'next' || 'legacy'}}
          OTP_VALUE: ${{steps.wait-for-secrets.outputs.OTP}}
        run: npm publish --access public --otp "$OTP_VALUE" --tag "$PUBLISH_TAG" "packages/worker/$TGZ_NAME"
      - uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        id: attest
        with:
          subject-path: packages/worker/${{env.TGZ_NAME}}
      - name: Rename attestation bundle
        run: mv "$BUNDLE_PATH" "packages/worker/$TGZ_NAME.sigstore.json"
        env:
          BUNDLE_PATH: ${{steps.attest.outputs.bundle-path}}
      - name: Update GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{needs.check_publish_worker.outputs.tag}}
          append_body: true
          fail_on_unmatched_files: true
          overwrite_files: false
          files: |
            packages/worker/${{env.TGZ_NAME}}
            packages/worker/${{env.TGZ_NAME}}.sigstore.json
          body: |

            [View attestation](${{steps.attest.outputs.attestation-url}}) â€¢ [Documentation](https://docs.github.com/en/actions/security-for-github-actions/using-artifact-attestations)
