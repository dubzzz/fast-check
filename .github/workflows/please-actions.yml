name: Please Actions

on:
  issue_comment:
    types:
      - created

jobs:
  please_deploy:
    name: 'Deploy the bundle of the current PR to Netlify'
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && github.event.comment.body == 'please deploy'
    steps:
      - uses: actions/checkout@v2.4.0
      - name: Check comment
        id: check_comment
        uses: actions/github-script@v5
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            // Check admin rights
            const levelResponse = await github.rest.repos.getCollaboratorPermissionLevel({
              ...context.repo,
              username: context.actor,
            });
            if (levelResponse.data.permission !== 'admin') {
              core.setFailed('"please deploy" can only be executed by an admin user');
            }
            // Add reaction to the comment
            const comment = context.payload.comment;
            await github.rest.reactions.createForIssueComment({
              ...context.repo,
              comment_id: comment.id,
              content: 'rocket',
            });
      - name: Checkout Pull Request
        run: hub pr checkout "${{github.event.issue.number}}"
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
      - name: Using Node v16.x
        uses: actions/setup-node@v2.5.0
        with:
          node-version: '16.x'
      - name: Install fast-check dependencies
        run: yarn --frozen-lockfile
      - name: Build package
        run: yarn build:prod-ci
      - name: Generate documentation
        run: yarn docs-ci
      - name: Generate bundle
        run: |
          yarn pack
          mv fast-check-*.tgz docs/fast-check.tgz
      - name: Install deploy-netlify dependencies
        run: |
          cd ./.github/actions/deploy-netlify
          yarn --frozen-lockfile
      - name: Deploy on Netlify
        uses: ./.github/actions/deploy-netlify
        env:
          NETLIFY_SITE_ID: ${{secrets.NETLIFY_APP_ID}}
          NETLIFY_AUTH_TOKEN: ${{secrets.NETLIFY_AUTH_TOKEN}}
