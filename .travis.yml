language: node_js
node_js:
 - '12'
 - '10'
 - '8'
 - '6'

cache:
  directories:
    - node_modules

script:
  - npm run test -- --maxWorkers=4
  - npm run e2e -- --maxWorkers=4

after_success:
  - if [[ $(node --version) == "v12."* ]]; then npm run coverage; fi

stages:
  - test
  - publish documentation
  - deploy

jobs:
  include:
    - stage: test
      env: STEP=FORMAT_LINT
      script:
        - npm run format:check
        - npm run lint:check
    - stage: test
      env: STEP=EXAMPLES_ROLLUP_LEGACY
      script:
        - npm run build
        - cd example ;
          bash run.sh ;
          cd ..
        - npm run prebuild
        - npm run build:publish-cjs
        - npm run build:publish-esm
        - npm run webbuild
        - npm run test:rollup-esm
        - npm run test:rollup-iife
        - nvm install 0.12 ;
          node test/legacy/main.js
    - stage: test
      env: STEP=HEAD
      script:
        - rm -r node_modules/
        - rm package-lock.json
        - npm install
        - npm run test -- --maxWorkers=4
        - npm run e2e -- --maxWorkers=4
    - stage: publish documentation
      if: branch = master AND type = push
      script:
        - npm run prebuild
        - npm run build:publish-types
        - npm run docs
      deploy:
        provider: pages
        skip-cleanup: true
        github-token: $GITHUB_TOKEN
        target-branch: gh-pages
        local-dir: docs
        on:
          branch: master
    - stage: deploy
      if: tag =~ ^v\d+\.
      script:
        - npm run prebuild
        - npm run build:publish-types
        - npm run build:publish-cjs
        - npm run build:publish-esm
        - npm run webbuild
      deploy:
        provider: npm
        email: npm@dubien.org
        skip_cleanup: true
        api_key:
          secure: GizKIQllRzN5PJ00VsmLgT4HFxrufIkrWHj+kjW7FIxWBvBu/ii02DV3+DHcIKOc082wCJ3MAJjpU098oOG4omKl0D36COIl92JP1L0hz5D0ZTshCnUsd0YXHcYYtjDEU0hK6iHoEETQl1+ejncqkoXyJFd9XmdT8vnXLvbUDvNpFmIFFFOVJ6aZX3nj2irgLHutC8cspYzjCs8OqRm1gftd5JhaOMfE6NgjiX5AHI8NJ8zHWYShb2vMpOG/ajzCrfMISvtsvU4Wa2K0cYhW9CkO7WAqSG/jFF6ZxDqzfch0SH+fZBu9u8iIk0GUwtEhv0SURFD0nJqLCN4AjGH0HkRXA6b8GCBD7ZRpnbmTKoB/HRROzEAvErqtWGO0qWZ8lF4U47i5rNCYC4DW/WB776MWsEDy0XQDcYRSfiLsVy544lsKjBXhziFWSqx2gL5GwAQiCUVKqZVZ9ouAZGcANzyq1v28tN38WsjMAjI96rcWaWeeY14zQ92NHhPLbFJUg/8F7Ddn2aRLp3JSyxVm+YubFHOl15oF0ZO6FjHkLhklse5o0seqljBkSrZwd6f/RV99+ziAAm8wenfODae/qrgVwS02CttsHOGlWTpjTbU96iAa8FiCpN9yWa9LYf+QNG5Dhjgm69WTVjA0SWkPA3PA4vI5uxUsnBCtBPawEVo=
        on:
          tags: true
      repo: dubzzz/fast-check
